<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¤××‘ ×¦'××˜ v1.4.6</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #0A1A3F; min-height: 100vh; display: flex; flex-direction: column; }
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; color: white; font-size: 18px; }
        .loading.hidden { display: none; }
        .header { background: #075e54; color: white; padding: 16px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .pub-name { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
        .online-count { font-size: 12px; opacity: 0.8; }
        .users-online { background: rgba(7, 94, 84, 0.1); padding: 16px; text-align: center; color: #075e54; border-bottom: 1px solid #ddd; overflow-x: auto; }
        .users-grid { display: inline-flex; gap: 16px; padding: 8px 0; }
        .user-card { background: white; border: 1px solid #ddd; border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-width: 100px; text-align: center; position: relative; }
        .user-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .user-card.current-user { background: #f0f0f0; cursor: default; }
        .user-card.blocked { opacity: 0.5; filter: grayscale(1); }
        .user-card-photo { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin: 0 auto 8px; border: 2px solid #075e54; }
        .user-card-photo.owner { border: 3px solid #ffd700; box-shadow: 0 0 8px rgba(255, 215, 0, 0.4); }
        .no-photo-placeholder { width: 50px; height: 50px; border-radius: 50%; background: #075e54; color: white; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-size: 20px; font-weight: 600; }
        .no-photo-placeholder.owner { background: #ffd700; color: #000; }
        .user-card-name { font-weight: 600; margin-bottom: 4px; color: #075e54; font-size: 14px; }
        .user-card-name.owner { color: #ffd700; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .user-card-status { font-size: 12px; color: #666; font-style: italic; }
        .online-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-left: 5px; }
        .online-indicator.online { background: #28a745; box-shadow: 0 0 4px #28a745; }
        .online-indicator.offline { background: #6c757d; }
        .lobby-container { flex: 1; display: flex; flex-direction: column; background: #e5ddd5; overflow: hidden; }
        .lobby-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
        .owner-message { background: linear-gradient(135deg, #ffd700, #ffed4e); border: 2px solid #ffd700; border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3); position: relative; }
        .owner-message::before { content: "ğŸ‘‘"; position: absolute; top: -10px; left: 15px; font-size: 20px; background: white; border-radius: 50%; padding: 5px; }
        .owner-message .message-header { font-weight: 700; color: #8B4513; margin-bottom: 10px; font-size: 16px; }
        .owner-message .message-content { color: #333; line-height: 1.5; margin-bottom: 10px; font-size: 16px; }
        .owner-message .message-time { font-size: 12px; color: #666; text-align: left; }
        .welcome-message { text-align: center; color: #888; font-size: 16px; font-style: italic; padding: 20px; background: rgba(255, 255, 255, 0.7); border-radius: 12px; margin: 16px 0; }
        .owner-input-area { background: linear-gradient(135deg, #ffd700, #ffed4e); padding: 16px; border-top: 3px solid #ffd700; display: none; }
        .owner-input-area.show { display: block; }
        .owner-input-container { display: flex; align-items: center; gap: 12px; background: white; border-radius: 25px; padding: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .owner-message-input { flex: 1; border: none; padding: 12px 16px; font-size: 16px; outline: none; font-family: 'Inter', sans-serif; }
        .owner-send-button, .file-upload-btn { border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.2s ease; }
        .owner-send-button { background: #075e54; color: white; }
        .file-upload-btn { background: #6EC1E4; color: #1a1a1a; }
        .viewer-message { background: rgba(255, 255, 255, 0.9); border: 1px solid #ddd; border-radius: 12px; padding: 20px; text-align: center; color: #666; font-style: italic; margin: 20px; font-size: 16px; }
        .private-chat { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: white; z-index: 1000; flex-direction: column; }
        .private-chat.show { display: flex; }
        .private-header { background: #075e54; color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; }
        .close-chat { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 8px; }
        .private-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; background: #e5ddd5; }
        .typing-indicator { text-align: center; color: #666; font-size: 14px; font-style: italic; padding: 8px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        .private-input-area { background: white; padding: 16px; display: flex; align-items: center; gap: 12px; border-top: 1px solid #ddd; }
        .private-input { flex: 1; border: 1px solid #ddd; border-radius: 25px; padding: 12px 16px; font-size: 16px; outline: none; }
        .private-send { background: #075e54; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .message { max-width: 70%; padding: 12px 16px; border-radius: 18px; word-wrap: break-word; font-size: 16px; line-height: 1.4; }
        .message.received { background: white; align-self: flex-start; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .message.sent { background: #dcf8c6; align-self: flex-end; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .message-header { font-size: 12px; font-weight: 600; color: #075e54; margin-bottom: 4px; }
        .message-time { font-size: 11px; color: #999; margin-top: 6px; }
        .username-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0A1A3F 0%, #1e3c72 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px; }
        .username-modal.hidden { display: none; }
        .modal-content { background: linear-gradient(135deg, #0A1A3F 0%, #1e3c72 100%); border: 2px solid rgba(110, 193, 228, 0.3); padding: 30px; border-radius: 20px; text-align: center; width: 100%; max-width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.6); }
        .modal-content h2 { margin-bottom: 16px; color: white; font-weight: 700; font-size: 24px; }
        .modal-content p { margin-bottom: 24px; color: #6EC1E4; font-size: 16px; }
        .modal-content input, .modal-content select { width: 100%; padding: 16px; border: 2px solid rgba(110, 193, 228, 0.5); border-radius: 12px; font-size: 16px; margin-bottom: 16px; text-align: center; font-family: 'Inter', sans-serif; background: rgba(255, 255, 255, 0.15); color: white; backdrop-filter: blur(10px); }
        .modal-content input::placeholder { color: rgba(255, 255, 255, 0.7); }
        .modal-content input:focus, .modal-content select:focus { outline: none; border-color: #6EC1E4; box-shadow: 0 0 0 3px rgba(110, 193, 228, 0.3); }
        .photo-upload { margin-bottom: 20px; }
        .photo-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #6EC1E4; margin-bottom: 12px; display: none; }
        .upload-btn { background: rgba(255, 255, 255, 0.15); border: 2px dashed #6EC1E4; padding: 20px; border-radius: 12px; cursor: pointer; color: #6EC1E4; font-size: 14px; transition: all 0.3s ease; }
        .upload-btn:hover { background: rgba(110, 193, 228, 0.2); color: white; }
        #photoInput, #fileInput { display: none; }
        .modal-content button { background: #6EC1E4; color: #1a1a1a; border: none; padding: 16px 32px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s ease; width: 100%; }
        .modal-content button:hover { background: #5BB1D1; transform: translateY(-1px); }
        .kick-button { position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; }
        .block-button { background: #dc3545; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 14px; margin: 8px; cursor: pointer; min-height: 44px; }
        .unblock-button { background: #28a745; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 14px; margin: 8px; cursor: pointer; min-height: 44px; }
    </style>
</head>
<body>
    <div class="loading" id="loading"><div>××ª×—×‘×¨ ×œ×©×¨×ª...</div></div>
    <div class="username-modal" id="usernameModal">
        <div class="modal-content">
            <h2>ğŸº ×‘×¨×•×›×™× ×”×‘××™× ×œ×¤××‘ ×¦'××˜!</h2>
            <p>×¡×¤×¨ ×œ× ×• ×§×¦×ª ×¢×œ ×¢×¦××š</p>
            <div class="photo-upload">
                <img id="photoPreview" class="photo-preview">
                <div class="upload-btn" id="photoUploadBtn">ğŸ“· ×”×•×¡×£ ×ª××•× ×ª ×¤×¨×•×¤×™×œ (××•×¤×¦×™×•× ×œ×™)</div>
                <input type="file" id="photoInput" accept="image/*">
            </div>
            <input type="text" id="usernameInput" placeholder="×”×©× ×©×œ×š..." maxlength="20">
            <input type="password" id="ownerPassword" placeholder="×¡×™×¡××ª OWNER (××•×¤×¦×™×•× ×œ×™)">
            <select id="statusSelect">
                <option value="">×‘×—×¨ ×¡×˜×˜×•×¡ (××•×¤×¦×™×•× ×œ×™)</option>
                <option value="×¤× ×•×™">×¤× ×•×™</option>
                <option value="×ª×¤×•×¡">×ª×¤×•×¡</option>
                <option value="××‘×•×œ×‘×œ">××‘×•×œ×‘×œ</option>
            </select>
            <button id="joinButton">×”×¦×˜×¨×£ ×œ×¦'××˜</button>
        </div>
    </div>
    <div class="header">
        <div class="pub-name">ğŸº ×¤××‘ ×¦'××˜ v1.4.6</div>
        <div class="online-count" id="onlineCount">××ª×—×‘×¨...</div>
    </div>
    <div class="users-online" id="usersOnline"><div class="users-grid"><div>××˜×¢×Ÿ ××©×ª××©×™×...</div></div></div>
    <div class="lobby-container">
        <div class="lobby-messages" id="lobbyMessages">
            <div class="welcome-message">ğŸ›ï¸ ×‘×¨×•×›×™× ×”×‘××™× ×œ×œ×•×‘×™ ×”×¤××‘!<br>×›××Ÿ ×”×× ×”×œ ×™×©×ª×£ ×¢×“×›×•× ×™× ×•×”×•×“×¢×•×ª ×—×©×•×‘×•×ª</div>
        </div>
        <div class="owner-input-area" id="ownerInputArea">
            <div class="owner-input-container">
                <button class="file-upload-btn" id="fileUploadBtn">ğŸ“</button>
                <input type="file" id="fileInput" accept="*/*">
                <input type="text" class="owner-message-input" placeholder="×›×ª×•×‘ ×”×•×“×¢×” ×œ×œ×•×‘×™..." id="ownerMessageInput">
                <button class="owner-send-button" id="ownerSendButton">â¤</button>
            </div>
        </div>
        <div class="viewer-message" id="viewerMessage" style="display: none;">ğŸ‘€ ××ª×” ×¦×•×¤×” ×‘×œ×•×‘×™ - ×¨×§ ×”×× ×”×œ ×™×›×•×œ ×œ×¤×¨×¡× ×”×•×“×¢×•×ª ×›××Ÿ</div>
    </div>
    <div class="private-chat" id="privateChat">
        <div class="private-header">
            <div></div>
            <span id="privateChatName">×¦'××˜ ×¤×¨×˜×™</span>
            <button class="close-chat" id="closeChatBtn">Ã—</button>
        </div>
        <div class="private-messages" id="privateMessages"></div>
        <div class="private-input-area">
            <input type="text" class="private-input" placeholder="×”×•×“×¢×” ×¤×¨×˜×™×ª..." id="privateInput">
            <button class="private-send" id="privateSendButton">â¤</button>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    <script>
const firebaseConfig={apiKey:"AIzaSyD0STbryzKWhnCzeDoyoLnvvQNjeHTurSg",authDomain:"pubav6679.firebaseapp.com",databaseURL:"https://pubav6679-default-rtdb.firebaseio.com",projectId:"pubav6679",storageBucket:"pubav6679.firebasestorage.app",messagingSenderId:"623522233176",appId:"1:623522233176:web:2e1741879cd880cfa6032d"};
let app,database,storage,currentUser=null,currentPrivateChat=null,lobbyMessagesRef,usersRef,privateMessagesRef,blockedUsersRef,typingRef,processedMessages=new Set(),blockedUsers=new Set(),typingTimeout=null;
const OWNER_PASSWORD="pub123";
function initFirebase(){try{app=firebase.initializeApp(firebaseConfig);database=firebase.database();storage=firebase.storage();lobbyMessagesRef=database.ref('lobbyMessages');usersRef=database.ref('users');privateMessagesRef=database.ref('privateMessages');blockedUsersRef=database.ref('blockedUsers');typingRef=database.ref('typing');database.ref('.info/connected').on('value',s=>{if(s.val()===true){document.getElementById('loading').classList.add('hidden');console.log('Connected')}});return true}catch(e){console.error('Firebase error:',e);document.getElementById('loading').innerHTML='<div>×©×’×™××”</div>';return false}}
function previewPhoto(file){const preview=document.getElementById('photoPreview'),uploadBtn=document.getElementById('photoUploadBtn');if(file){const reader=new FileReader();reader.onload=e=>{preview.src=e.target.result;preview.style.display='block';uploadBtn.innerHTML='âœ… ×ª××•× ×” × ×‘×—×¨×”'};reader.readAsDataURL(file)}}
async function uploadPhoto(file){if(!file||!storage)return null;try{const filename=`profile_${Date.now()}_${Math.random().toString(36).substring(7)}.jpg`,storageRef=storage.ref(`profile-photos/${filename}`),uploadTask=await storageRef.put(file);return await uploadTask.ref.getDownloadURL()}catch(e){console.error('Photo error:',e);alert('×©×’×™××” ×‘×”×¢×œ××ª ×ª××•× ×”');return null}}
async function joinChat(){try{const username=document.getElementById('usernameInput').value.trim(),ownerPassword=document.getElementById('ownerPassword').value.trim(),status=document.getElementById('statusSelect').value,photoFile=document.getElementById('photoInput').files[0];let finalUsername=username,isOwner=false;if(ownerPassword){if(ownerPassword===OWNER_PASSWORD){finalUsername="OWNER";isOwner=true}else{alert('×¡×™×¡××ª OWNER ×©×’×•×™×”');return}}else if(!username){alert('×× × ×”×›× ×¡ ×©× ××©×ª××©');return}document.getElementById('loading').classList.remove('hidden');let photoURL=null;if(photoFile){photoURL=await uploadPhoto(photoFile)}currentUser={name:finalUsername,id:Date.now()+'_'+Math.floor(Math.random()*10000),joinTime:Date.now(),photoURL,status,isOwner,online:true};const userRef=usersRef.child(currentUser.id);await userRef.set(currentUser);database.ref('.info/connected').on('value',snap=>{if(snap.val()===true){userRef.update({online:true});userRef.onDisconnect().update({online:false})}});userRef.onDisconnect().remove();document.getElementById('loading').classList.add('hidden');document.getElementById('usernameModal').classList.add('hidden');setupUI();setupListeners();loadBlockedUsers();addSystemMessage(isOwner?`ğŸ‘‘ ×”×× ×”×œ ${finalUsername} ×”×¦×˜×¨×£ ×œ×œ×•×‘×™`:`${finalUsername} ×”×¦×˜×¨×£ ×œ×œ×•×‘×™`)}catch(e){console.error('Join error:',e);document.getElementById('loading').classList.add('hidden');alert('×©×’×™××”: '+e.message)}}
function setupUI(){const ownerInputArea=document.getElementById('ownerInputArea'),viewerMessage=document.getElementById('viewerMessage');if(currentUser&&currentUser.isOwner){ownerInputArea.classList.add('show');viewerMessage.style.display='none'}else{ownerInputArea.classList.remove('show');viewerMessage.style.display='block'}}
function sendLobbyMessage(){if(!currentUser||!currentUser.isOwner)return;const input=document.getElementById('ownerMessageInput'),text=input.value.trim();if(!text)return;lobbyMessagesRef.push({id:Date.now()+'_'+Math.floor(Math.random()*10000),text,sender:currentUser.name,senderId:currentUser.id,timestamp:Date.now(),type:'owner_message'});input.value=''}
function addSystemMessage(text){lobbyMessagesRef.push({id:Date.now()+'_system',text,sender:'System',senderId:'system',timestamp:Date.now(),type:'system'})}
function displayLobbyMessage(msg){const container=document.getElementById('lobbyMessages'),messageDiv=document.createElement('div');if(msg.type==='owner_message'){messageDiv.className='owner-message';messageDiv.innerHTML=`<div class="message-header">ğŸ‘‘ ${escapeHtml(msg.sender)}</div><div class="message-content">${escapeHtml(msg.text)}</div><div class="message-time">${formatTime(msg.timestamp)}</div>`}else if(msg.type==='system'){messageDiv.className='welcome-message';messageDiv.innerHTML=`ğŸ“¢ ${escapeHtml(msg.text)}`}container.appendChild(messageDiv);container.scrollTop=container.scrollHeight}
function setupListeners(){lobbyMessagesRef.on('child_added',s=>displayLobbyMessage(s.val()));usersRef.on('value',s=>updateUsersList(s.val()||{}));privateMessagesRef.on('child_added',s=>{const chatData=s.val(),chatId=s.key;if(chatId&&chatId.includes(currentUser.id)){privateMessagesRef.child(chatId).on('child_added',ms=>{const msg=ms.val();if(msg&&msg.recipientId===currentUser.id&&msg.senderId!==currentUser.id){if(blockedUsers.has(msg.senderId))return;const key=`${chatId}_${msg.id}`;if(!processedMessages.has(key)){processedMessages.add(key);if(!currentPrivateChat||currentPrivateChat.id!==msg.senderId){showPrivateMessageNotification(msg)}}}})}})
}
function loadBlockedUsers(){if(!currentUser||!blockedUsersRef)return;try{blockedUsersRef.child(currentUser.id).on('value',s=>{const blocked=s.val()||{};blockedUsers.clear();Object.keys(blocked).forEach(id=>blockedUsers.add(id));if(usersRef){usersRef.once('value',us=>updateUsersList(us.val()||{}))}})}catch(e){console.error('Error loading blocked:',e)}}
function updateUsersList(users){const container=document.getElementById('usersOnline'),userCount=Object.keys(users).length;document.getElementById('onlineCount').textContent=`${userCount} ${userCount===1?'××“× ××—×•×‘×¨':'×× ×©×™× ××—×•×‘×¨×™×'}`;const grid=document.createElement('div');grid.className='users-grid';Object.values(users).forEach(user=>{const isBlocked=blockedUsers.has(user.id),userCard=document.createElement('div');userCard.className=`user-card ${user.id===currentUser?.id?'current-user':''} ${isBlocked?'blocked':''}`;let photoHTML='';if(user.photoURL){photoHTML=`<img src="${user.photoURL}" class="user-card-photo ${user.isOwner?'owner':''}" alt="×¤×¨×•×¤×™×œ">`}else{const initial=user.name?user.name.charAt(0).toUpperCase():'?';photoHTML=`<div class="no-photo-placeholder ${user.isOwner?'owner':''}">${initial}</div>`}const statusHTML=user.status?`<div class="user-card-status">${user.status}</div>`:'',ownerTag=user.isOwner?' ğŸ‘‘':'',blockedHTML=isBlocked?`<div style="color: #f44336; font-size: 10px; font-weight: 600;">ğŸš« ×—×¡×•×</div>`:'',onlineClass=user.online?'online':'offline',onlineHTML=`<span class="online-indicator ${onlineClass}" title="${user.online?'××—×•×‘×¨':'×œ× ××—×•×‘×¨'}"></span>`;let kickButton='';if(currentUser&&currentUser.isOwner&&user.id!==currentUser.id&&!user.isOwner){kickButton=`<button class="kick-button" data-user-id="${user.id}" data-user-name="${escapeHtml(user.name)}">Ã—</button>`}userCard.innerHTML=`${kickButton}${photoHTML}<div class="user-card-name ${user.isOwner?'owner':''}">${escapeHtml(user.name||'××©×ª××©')}${ownerTag} ${onlineHTML}</div>${statusHTML}${blockedHTML}`;if(user.id!==currentUser?.id){userCard.addEventListener('click',e=>{if(!e.target.classList.contains('kick-button')){openPrivateChat(user.name||'××©×ª××©',user.id)}})}const kickBtn=userCard.querySelector('.kick-button');if(kickBtn){kickBtn.addEventListener('click',e=>{e.stopPropagation();kickUser(kickBtn.dataset.userId,kickBtn.dataset.userName)})}grid.appendChild(userCard)});container.innerHTML='';container.appendChild(grid)}
function kickUser(userId,userName){if(!currentUser||!currentUser.isOwner||userId===currentUser.id)return;if(confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×¡×™×¨ ××ª ${userName}?`)){usersRef.child(userId).remove();addSystemMessage(`ğŸ‘‘ ×”×× ×”×œ ×”×¡×™×¨ ××ª ${userName} ××”×¤××‘`)}}
function blockUser(userId,userName){if(!currentUser||userId===currentUser.id)return;usersRef.child(userId).once('value',s=>{const targetUser=s.val();if(targetUser&&targetUser.isOwner){alert('×œ× × ×™×ª×Ÿ ×œ×—×¡×•× ××ª ×”×× ×”×œ');return}try{blockedUsersRef.child(currentUser.id).child(userId).set(true);blockedUsers.add(userId);const buttonArea=document.querySelector('#privateMessages .block-button');if(buttonArea){buttonArea.outerHTML=`<button class="unblock-button" onclick="unblockUser('${userId}', '${userName}')">×‘×˜×œ ×—×¡×™××”</button>`}alert(`${userName} × ×—×¡× ×‘×”×¦×œ×—×”`)}catch(e){console.error('Error blocking:',e);alert('×©×’×™××” ×‘×—×¡×™××”')}})}
function unblockUser(userId,userName){if(!currentUser)return;try{blockedUsersRef.child(currentUser.id).child(userId).remove();blockedUsers.delete(userId);const buttonArea=document.querySelector('#privateMessages .unblock-button');if(buttonArea){buttonArea.outerHTML=`<button class="block-button" onclick="blockUser('${userId}', '${userName}')">×—×¡×•× ××©×ª××©</button>`}alert(`×”×—×¡×™××” ×©×œ ${userName} ×‘×•×˜×œ×”`)}catch(e){console.error('Error unblocking:',e);alert('×©×’×™××”')}}
function setTyping(chatId,isTyping){if(!currentUser||!typingRef)return;const typingPath=typingRef.child(chatId).child(currentUser.id);if(isTyping){typingPath.set({name:currentUser.name,timestamp:Date.now()});typingPath.onDisconnect().remove()}else{typingPath.remove()}}
function listenToTyping(chatId,otherUserId){if(!typingRef)return;typingRef.child(chatId).child(otherUserId).on('value',s=>{const typingData=s.val(),typingIndicator=document.getElementById('typingIndicator');if(typingData&&typingData.name){if(!typingIndicator){const indicator=document.createElement('div');indicator.id='typingIndicator';indicator.className='typing-indicator';indicator.textContent=`${typingData.name} ××§×œ×™×“...`;document.getElementById('privateMessages').appendChild(indicator)}}else{if(typingIndicator){typingIndicator.remove()}}})}
function handlePrivateTyping(){if(!currentPrivateChat||!currentUser)return;const chatId=[currentUser.id,currentPrivateChat.id].sort().join('_');setTyping(chatId,true);if(typingTimeout)clearTimeout(typingTimeout);typingTimeout=setTimeout(()=>setTyping(chatId,false),3000)}
function openPrivateChat(userName,userId){if(userId===currentUser?.id)return;currentPrivateChat={name:userName,id:userId};document.getElementById('privateChatName').textContent=`×¦'××˜ ×¤×¨×˜×™ ×¢× ${userName}`;document.getElementById('privateChat').classList.add('show');const isBlocked=blockedUsers.has(userId),blockButtonHTML=isBlocked?`<button class="unblock-button" onclick="unblockUser('${userId}', '${userName}')">×‘×˜×œ ×—×¡×™××”</button>`:`<button class="block-button" onclick="blockUser('${userId}', '${userName}')">×—×¡×•× ××©×ª××©</button>`,welcomeMessage=isBlocked?`<div style="text-align: center; color: #888; padding: 20px; font-size: 16px;">ğŸš« ×¦'××˜ ×¤×¨×˜×™ ×¢× ${userName} (×—×¡×•×)</div>`:`<div style="text-align: center; color: #888; padding: 20px; font-size: 16px;">ğŸ’¬ ×”×ª×—×œ×ª ×¦'××˜ ×¤×¨×˜×™ ×¢× ${userName}</div>`;document.getElementById('privateMessages').innerHTML=`${welcomeMessage}<div style="text-align: center; padding: 16px; border-bottom: 1px solid #ddd; background: #f8f9fa;">${blockButtonHTML}</div>`;const chatId=[currentUser.id,userId].sort().join('_'),privateChatRef=privateMessagesRef.child(chatId);privateChatRef.off();privateChatRef.on('child_added',s=>displayPrivateMessage(s.val()));listenToTyping(chatId,userId)}
function closePrivateChat(){if(currentPrivateChat){const chatId=[currentUser.id,currentPrivateChat.id].sort().join('_');setTyping(chatId,false)}document.getElementById('privateChat').classList.remove('show');currentPrivateChat=null}
function sendPrivateMessage(){const input=document.getElementById('privateInput'),text=input.value.trim();if(!text||!currentPrivateChat||!currentUser)return;if(blockedUsers.has(currentPrivateChat.id)){alert('×œ× × ×™×ª×Ÿ ×œ×©×œ×•×— ×”×•×“×¢×” ×œ××©×ª××© ×—×¡×•×');return}const chatId=[currentUser.id,currentPrivateChat.id].sort().join('_');setTyping(chatId,false);blockedUsersRef.child(currentPrivateChat.id).child(currentUser.id).once('value',s=>{if(s.exists()){alert('×œ× × ×™×ª×Ÿ ×œ×©×œ×•×— ×”×•×“×¢×” - ×”××©×ª××© ×—×¡× ××•×ª×š');return}privateMessagesRef.child(chatId).push({id:Date.now()+'_'+Math.floor(Math.random()*10000),text,sender:currentUser.name,senderId:currentUser.id,recipient:currentPrivateChat.name,recipientId:currentPrivateChat.id,timestamp:Date.now(),chatId});input.value=''})}
function displayPrivateMessage(msg){if(blockedUsers.has(msg.senderId))return;const container=document.getElementById('privateMessages'),messageDiv=document.createElement('div'),isOwn=msg.senderId===currentUser?.id;messageDiv.className=`message ${isOwn?'sent':'received'}`;let messageHTML='';if(!isOwn){messageHTML+=`<div class="message-header">${escapeHtml(msg.sender)}</div>`}messageHTML+=`<div>${escapeHtml(msg.text)}</div><div class="message-time">${formatTime(msg.timestamp)}</div>`;messageDiv.innerHTML=messageHTML;container.appendChild(messageDiv);container.scrollTop=container.scrollHeight}
function showPrivateMessageNotification(msg){if(blockedUsers.has(msg.senderId))return;const notificationDiv=document.createElement('div');notificationDiv.style.cssText='position: fixed;top: 70px;left: 50%;transform: translateX(-50%);background: #ff4444;color: white;padding: 16px 20px;border-radius: 12px;z-index: 10000;box-shadow: 0 4px 16px rgba(0,0,0,0.3);font-size: 14px;cursor: pointer;max-width: 90%;text-align: center;';notificationDiv.innerHTML=`ğŸ’¬ ${msg.sender}: ${escapeHtml(msg.text.substring(0,50))}${msg.text.length>50?'...':''}`;notificationDiv.onclick=()=>{openPrivateChat(msg.sender,msg.senderId);document.body.removeChild(notificationDiv)};document.body.appendChild(notificationDiv);setTimeout(()=>{if(document.body.contains(notificationDiv)){document.body.removeChild(notificationDiv)}},5000)}
function formatTime(timestamp){const date=new Date(timestamp),hours=date.getHours().toString().padStart(2,'0'),minutes=date.getMinutes().toString().padStart(2,'0');return`${hours}:${minutes}`}
function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML}
function setupEventListeners(){document.getElementById('joinButton').addEventListener('click',joinChat);document.getElementById('photoUploadBtn').addEventListener('click',()=>document.getElementById('photoInput').click());document.getElementById('photoInput').addEventListener('change',e=>{if(e.target.files[0]){previewPhoto(e.target.files[0])}});document.getElementById('ownerSendButton').addEventListener('click',sendLobbyMessage);document.getElementById('ownerMessageInput').addEventListener('keypress',e=>{if(e.key==='Enter'){sendLobbyMessage()}});document.getElementById('usernameInput').addEventListener('keypress',e=>{if(e.key==='Enter'){joinChat()}});document.getElementById('closeChatBtn').addEventListener('click',closePrivateChat);document.getElementById('privateSendButton').addEventListener('click',sendPrivateMessage);document.getElementById('privateInput').addEventListener('input',handlePrivateTyping);document.getElementById('privateInput').addEventListener('keypress',e=>{if(e.key==='Enter'){sendPrivateMessage()}})}
window.addEventListener('DOMContentLoaded',()=>{console.log('App starting...');if(initFirebase()){console.log('Firebase initialized successfully');setupEventListeners();console.log('Event listeners setup complete')}else{console.error('Firebase initialization failed')}});
window.addEventListener('beforeunload',()=>{if(currentUser&&usersRef){usersRef.child(currentUser.id).remove()}if(currentPrivateChat){const chatId=[currentUser.id,currentPrivateChat.id].sort().join('_');setTyping(chatId,false)}});
window.joinChat=joinChat;window.sendLobbyMessage=sendLobbyMessage;window.openPrivateChat=openPrivateChat;window.closePrivateChat=closePrivateChat;window.kickUser=kickUser;window.blockUser=blockUser;window.unblockUser=unblockUser;
console.log('Script loaded successfully - v1.4.6');
    </script>
</body>
</html>
